{% extends 'base.html' %}
{% load static %}

{% block title %}Desejos Secretos - Finalizar Compra{% endblock %}

{% block extra_css %}
<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Carrinho CSS -->
<link rel="stylesheet" href="{% static 'css/carrinho.css' %}">
{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-decoration-none">Início</a></li>
            <li class="breadcrumb-item"><a href="{% url 'carrinho:carrinho' %}" class="text-decoration-none">Carrinho</a></li>
            <li class="breadcrumb-item active">Checkout</li>
        </ol>
    </nav>

    <!-- Indicador de Etapas -->
    <div class="step-indicator">
        <div class="step completed">
            <div class="step-circle">
                <i class="fas fa-check"></i>
            </div>
            <small>Carrinho</small>
        </div>
        <div class="step active">
            <div class="step-circle">2</div>
            <small>Dados</small>
        </div>
        <div class="step">
            <div class="step-circle">3</div>
            <small>Pagamento</small>
        </div>
        <div class="step">
            <div class="step-circle">4</div>
            <small>Confirmação</small>
        </div>
    </div>

    <div class="row">
        <!-- Formulário de Checkout -->
        <div class="col-lg-8">
            <form id="checkout-form" method="post">
                {% csrf_token %}
                
                <!-- Dados Pessoais -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-user"></i> Dados Pessoais
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="nome" name="nome" 
                                           placeholder="Seu nome completo" required>
                                    <label for="nome">Nome Completo *</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="email" class="form-control" id="email" name="email" 
                                           placeholder="seu@email.com" required>
                                    <label for="email">E-mail *</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="tel" class="form-control" id="telefone" name="telefone" 
                                           placeholder="(11) 99999-9999" required>
                                    <label for="telefone">Telefone/WhatsApp *</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="cpf" name="cpf" 
                                           placeholder="000.000.000-00">
                                    <label for="cpf">CPF</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Endereço de Entrega -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-map-marker-alt"></i> Endereço de Entrega
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="cep" name="cep" 
                                           placeholder="00000-000" required maxlength="9">
                                    <label for="cep">CEP *</label>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="endereco" name="endereco" 
                                           placeholder="Rua, avenida..." required>
                                    <label for="endereco">Endereço *</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="numero" name="numero" 
                                           placeholder="123" required>
                                    <label for="numero">Número *</label>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="complemento" name="complemento" 
                                           placeholder="Apto, bloco...">
                                    <label for="complemento">Complemento</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="bairro" name="bairro" 
                                           placeholder="Seu bairro" required>
                                    <label for="bairro">Bairro *</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="cidade" name="cidade" 
                                           placeholder="Sua cidade" required>
                                    <label for="cidade">Cidade *</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating mb-3">
                                    <select class="form-select" id="estado" name="estado" required>
                                        <option value="">Selecione...</option>
                                        <option value="AC">Acre</option>
                                        <option value="AL">Alagoas</option>
                                        <option value="AP">Amapá</option>
                                        <option value="AM">Amazonas</option>
                                        <option value="BA">Bahia</option>
                                        <option value="CE">Ceará</option>
                                        <option value="DF">Distrito Federal</option>
                                        <option value="ES">Espírito Santo</option>
                                        <option value="GO">Goiás</option>
                                        <option value="MA">Maranhão</option>
                                        <option value="MT">Mato Grosso</option>
                                        <option value="MS">Mato Grosso do Sul</option>
                                        <option value="MG">Minas Gerais</option>
                                        <option value="PA">Pará</option>
                                        <option value="PB">Paraíba</option>
                                        <option value="PR">Paraná</option>
                                        <option value="PE">Pernambuco</option>
                                        <option value="PI">Piauí</option>
                                        <option value="RJ">Rio de Janeiro</option>
                                        <option value="RN">Rio Grande do Norte</option>
                                        <option value="RS">Rio Grande do Sul</option>
                                        <option value="RO">Rondônia</option>
                                        <option value="RR">Roraima</option>
                                        <option value="SC">Santa Catarina</option>
                                        <option value="SP">São Paulo</option>
                                        <option value="SE">Sergipe</option>
                                        <option value="TO">Tocantins</option>
                                    </select>
                                    <label for="estado">Estado *</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Forma de Pagamento -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-credit-card"></i> Forma de Pagamento
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="payment-option" data-payment="cartao">
                            <div class="row align-items-center">
                                <div class="col-1">
                                    <input type="radio" name="forma_pagamento" value="cartao" id="cartao" 
                                           required title="Cartão de Crédito" aria-label="Selecionar cartão de crédito">
                                </div>
                                <div class="col-2">
                                    <i class="fas fa-credit-card text-primary fa-2x"></i>
                                </div>
                                <div class="col-9">
                                    <h6 class="mb-1">Cartão de Crédito</h6>
                                    <small class="text-muted">Até 12x sem juros</small>
                                </div>
                            </div>
                        </div>

                        <div class="payment-option" data-payment="pix">
                            <div class="row align-items-center">
                                <div class="col-1">
                                    <input type="radio" name="forma_pagamento" value="pix" id="pix"
                                           title="PIX" aria-label="Selecionar PIX">
                                </div>
                                <div class="col-2">
                                    <i class="fas fa-qrcode text-success fa-2x"></i>
                                </div>
                                <div class="col-9">
                                    <h6 class="mb-1">PIX</h6>
                                    <small class="text-muted">Aprovação instantânea - 5% de desconto</small>
                                </div>
                            </div>
                        </div>

                        <div class="payment-option" data-payment="boleto">
                            <div class="row align-items-center">
                                <div class="col-1">
                                    <input type="radio" name="forma_pagamento" value="boleto" id="boleto"
                                           title="Boleto Bancário" aria-label="Selecionar boleto bancário">
                                </div>
                                <div class="col-2">
                                    <i class="fas fa-barcode text-warning fa-2x"></i>
                                </div>
                                <div class="col-9">
                                    <h6 class="mb-1">Boleto Bancário</h6>
                                    <small class="text-muted">Vencimento em 3 dias úteis</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Observações -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-comment"></i> Observações (Opcional)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-floating">
                            <textarea class="form-control observacoes-textarea" id="observacoes" name="observacoes" 
                                      placeholder="Alguma observação sobre o pedido?"></textarea>
                            <label for="observacoes">Observações sobre o pedido</label>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Resumo do Pedido -->
        <div class="col-lg-4">
            <div class="checkout-summary">
                <h5 class="mb-3">
                    <i class="fas fa-shopping-bag"></i> Resumo do Pedido
                </h5>

                <!-- Itens do Carrinho -->
                <div class="mb-3">
                    {% for item in itens %}
                    <div class="product-mini">
                        {% if item.produto.imagem_principal %}
                            <img src="{{ item.produto.imagem_principal.url }}" alt="{{ item.produto.nome }}">
                        {% else %}
                            <div class="product-mini-placeholder">
                                <i class="fas fa-heart text-muted"></i>
                            </div>
                        {% endif %}
                        <div class="flex-grow-1">
                            <h6 class="mb-0">{{ item.produto.nome }}</h6>
                            <small class="text-muted">Qtd: {{ item.quantidade }}</small>
                            <div class="fw-bold text-primary">R$ {{ item.total|floatformat:2 }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <hr>

                <!-- Cálculos -->
                <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <span>R$ {{ carrinho.subtotal|floatformat:2 }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Frete:</span>
                    <span class="frete-valor">
                        {% if carrinho.valor_frete > 0 %}
                            R$ {{ carrinho.valor_frete|floatformat:2 }}
                        {% else %}
                            A calcular
                        {% endif %}
                    </span>
                </div>
                <div class="d-flex justify-content-between mb-2 desconto-pix">
                    <span class="text-success">Desconto PIX (5%):</span>
                    <span class="text-success desconto-valor">- R$ 0,00</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between fw-bold text-primary fs-5">
                    <span>Total:</span>
                    <span class="total-valor">R$ {{ carrinho.total|floatformat:2 }}</span>
                </div>

                <div class="d-grid gap-2 mt-4">
                    <button type="submit" form="checkout-form" class="btn btn-primary btn-lg">
                        <i class="fas fa-lock"></i> Finalizar Compra
                    </button>
                    <a href="{% url 'carrinho:carrinho' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Voltar ao Carrinho
                    </a>
                </div>

                <!-- Selos de Segurança -->
                <div class="text-center mt-4">
                    <small class="text-muted">
                        <i class="fas fa-shield-alt text-success"></i> Compra 100% segura<br>
                        <i class="fas fa-truck text-primary"></i> Entrega garantida<br>
                        <i class="fas fa-undo text-info"></i> 7 dias para troca
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Dados do checkout para JS via data-attributes (evita conflito com lint de templates) -->
<div id="checkout-data"
     data-subtotal="{{ carrinho.subtotal|default_if_none:0 }}"
     data-frete="{{ carrinho.valor_frete|default_if_none:0 }}"></div>

<script>
$(document).ready(function() {
    var el = document.getElementById('checkout-data');
    var ds = el ? el.dataset : {};
    window.checkoutData = {
        subtotal: parseFloat(ds.subtotal || '0'),
        frete: parseFloat(ds.frete || '0')
    };
});
</script>
{% endblock %}
